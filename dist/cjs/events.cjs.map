{"version":3,"file":"events.cjs","sources":["../../src/events.ts"],"sourcesContent":["/* eslint-disable no-console */\n// src/events.ts\nimport type { UsageMetadata, BaseMessageFields } from '@langchain/core/messages';\nimport type { Graph } from '@/graphs';\nimport type * as t from '@/types';\nimport { handleToolCalls } from '@/stream';\nimport { Providers } from '@/common';\n\nexport class HandlerRegistry {\n  private handlers: Map<string, t.EventHandler> = new Map();\n\n  register(eventType: string, handler: t.EventHandler): void {\n    this.handlers.set(eventType, handler);\n  }\n\n  getHandler(eventType: string): t.EventHandler | undefined {\n    return this.handlers.get(eventType);\n  }\n}\n\nexport class ModelEndHandler implements t.EventHandler {\n  collectedUsage?: UsageMetadata[];\n  constructor(collectedUsage?: UsageMetadata[]) {\n    if (collectedUsage && !Array.isArray(collectedUsage)) {\n      throw new Error('collectedUsage must be an array');\n    }\n    this.collectedUsage = collectedUsage;\n  }\n\n  handle(event: string, data: t.ModelEndData, metadata?: Record<string, unknown>, graph?: Graph): void {\n    if (!graph || !metadata) {\n      console.warn(`Graph or metadata not found in ${event} event`);\n      return;\n    }\n\n    const usage = data?.output?.usage_metadata;\n    if (usage != null && this.collectedUsage != null) {\n      this.collectedUsage.push(usage);\n    }\n\n    console.log(`====== ${event.toUpperCase()} ======`);\n    console.dir({\n      usage,\n    }, { depth: null });\n\n    if (metadata.provider !== Providers.GOOGLE) {\n      return;\n    }\n\n    handleToolCalls(data?.output?.tool_calls, metadata, graph);\n  }\n}\n\nexport class ToolEndHandler implements t.EventHandler {\n  private callback?: t.ToolEndCallback;\n  constructor(callback?: t.ToolEndCallback) {\n    this.callback = callback;\n  }\n  handle(event: string, data: t.StreamEventData | undefined, metadata?: Record<string, unknown>, graph?: Graph): void {\n    if (!graph || !metadata) {\n      console.warn(`Graph or metadata not found in ${event} event`);\n      return;\n    }\n\n    const toolEndData = data as t.ToolEndData | undefined;\n    if (!toolEndData?.output) {\n      console.warn('No output found in tool_end event');\n      return;\n    }\n\n    this.callback?.(toolEndData, metadata);\n\n    graph.handleToolCallCompleted({ input: toolEndData.input, output: toolEndData.output }, metadata);\n  }\n}\n\nexport class TestLLMStreamHandler implements t.EventHandler {\n  handle(event: string, data: t.StreamEventData | undefined): void {\n    const chunk = data?.chunk;\n    const  isMessageChunk = !!(chunk && 'message' in chunk);\n    const msg = isMessageChunk ? chunk.message : undefined;\n    if (msg && msg.tool_call_chunks && msg.tool_call_chunks.length > 0) {\n      console.log(msg.tool_call_chunks);\n    } else if (msg && msg.content) {\n      if (typeof msg.content === 'string') {\n        process.stdout.write(msg.content);\n      }\n    }\n  }\n}\n\nexport class TestChatStreamHandler implements t.EventHandler {\n  handle(event: string, data: t.StreamEventData | undefined): void {\n    const chunk = data?.chunk;\n    const isContentChunk = !!(chunk && 'content' in chunk);\n    const content = isContentChunk && chunk.content;\n\n    if (!content || !isContentChunk) {\n      return;\n    }\n\n    if (chunk.tool_call_chunks && chunk.tool_call_chunks.length > 0) {\n      console.dir(chunk.tool_call_chunks, { depth: null });\n    }\n\n    if (typeof content === 'string') {\n      process.stdout.write(content);\n    } else {\n      console.dir(content, { depth: null });\n    }\n  }\n}\n\nexport class LLMStreamHandler implements t.EventHandler {\n  handle(event: string, data: t.StreamEventData | undefined, metadata?: Record<string, unknown>): void {\n    const chunk = data?.chunk;\n    const  isMessageChunk = !!(chunk && 'message' in chunk);\n    const msg = isMessageChunk && chunk.message;\n    if (metadata) { console.log(metadata); }\n    if (msg && msg.tool_call_chunks && msg.tool_call_chunks.length > 0) {\n      console.log(msg.tool_call_chunks);\n    } else if (msg && msg.content) {\n      if (typeof msg.content === 'string') {\n        // const text_delta = msg.content;\n        // dispatchCustomEvent(GraphEvents.CHAT_MODEL_STREAM, { chunk }, config);\n        process.stdout.write(msg.content);\n      }\n    }\n  }\n}\n\nexport const createMetadataAggregator = (_collected?: Record<string, NonNullable<BaseMessageFields['response_metadata']>>[]): t.MetadataAggregatorResult => {\n  const collected = _collected || [];\n\n  const handleLLMEnd: t.HandleLLMEnd = (output) => {\n    const { generations } = output;\n    const lastMessageOutput = (generations[generations.length - 1] as (t.StreamGeneration | undefined)[] | undefined)?.[0];\n    if (!lastMessageOutput) {\n      return;\n    }\n    const { message } = lastMessageOutput;\n    if (message?.response_metadata) {\n      collected.push(message.response_metadata);\n    }\n  };\n\n  return { handleLLMEnd, collected };\n};"],"names":["Providers","handleToolCalls"],"mappings":"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"}